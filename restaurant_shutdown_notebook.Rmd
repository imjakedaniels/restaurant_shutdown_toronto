---
title: "restaurant_viz"
output: html_document
---

```{r}
library(tidyverse)
library(lubridate)
library(gganimate)
library(grid)
library(png)
library(extrafont)
```

# Load data

```{r}
open_table_full <- read_csv("dataset/state_of_industry_data.csv") %>%
  janitor::clean_names()
```

# Clean data

```{r}
# filter for Toronto data & fix dates to filter for March
open_table_canadian <- open_table_full %>%
  filter(name == "Toronto") %>% 
  gather(date, percent_change_yoy, -type, -name) %>%
  mutate(date = paste0("2020-0", str_extract(date, "[0-9]"), "-", str_extract(date, "[0-9]{2}")),
         date = ymd(date)) %>%
  filter(date >= as.Date("2020-03-01"))
```

# Load Tweet Images

```{r}
# school shutdown tweet
ford_12 <- rasterGrob(
  readPNG("tweet_img/ford_mar_12.PNG"), interpolate=TRUE)

# state of emergency tweet
ford_17 <- rasterGrob(
  readPNG("tweet_img/state_of_emerg.PNG"), interpolate=TRUE)
```

# Base Plot

```{r, fig.height = 6, fig.width = 10.6667, units = "in"}
p <- open_table_canadian %>%
  ggplot(aes(x = date, y = percent_change_yoy, fill = percent_change_yoy)) +
  geom_col(aes(group = date), width = 1) +
  geom_curve(data = open_table_canadian %>% filter(date == as.Date("2020-03-12")), 
             aes(x = as.Date("2020-03-12"), 
                 y = 25, 
                 xend = as.Date("2020-03-12"), 
                 yend = 1), 
             colour = 'white', 
             size = 1, 
             curvature = 0,
             arrow = arrow(length = unit(0.3, "cm"))) +
  annotation_custom(ford_12, 
                    ymin = 10, ymax= 100,
                    xmin = as.Date("2020-02-29"), 
                    xmax =  as.Date("2020-03-16")) +
  geom_curve(data = open_table_canadian %>% filter(date == as.Date("2020-03-17")), 
             aes(x = as.Date("2020-03-17"), 
                 y = 25, 
                 xend = as.Date("2020-03-17"), 
                 yend = 1), 
             colour = 'white', 
             size = 1, 
             curvature = 0,
             arrow = arrow(length = unit(0.3, "cm"))) +
  annotation_custom(ford_17, 
                    ymin = 10, ymax= 100,
                    xmin = as.Date("2020-03-16"), 
                    xmax =  as.Date("2020-04-01")) +
  
  labs(title = "Toronto Restaurant Shutdown Timeline — March 2020",
       subtitle = "Shown below is Toronto's year-over-year seated customers at restaurants via OpenTable.",
       caption = "\nSOURCE: https://www.opentable.com/state-of-industry") +
  scale_fill_gradient2(low = "red", high = "white", midpoint = 25) +
  scale_y_continuous(name = "Year-over-Year Change",
                     breaks = seq(100, -100, by = -50),
                     labels = c("100%", "50%", "0%", 
                                "-50%", "-100%")) +
  scale_x_date(name = "Month of March 2020 —>",
               breaks = c(as.Date("2020-03-01"), as.Date("2020-03-31")),
               labels = c( "Mar 01", "Mar 31")) +
  expand_limits(y = 100, x = as.Date("2020-03-31")) +
  theme(text = element_text(colour = "white", family = "Montserrat ExtraBold"),
        plot.title = element_text(size = 20, family = "Merriweather Black"),
        plot.subtitle = element_text(size = 12, family = "Merriweather Black"),
        plot.caption = element_text(face = "italic", colour = "grey 50"),
        legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_line(colour = "grey20"),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_text(face = "bold"),
        axis.text.y = element_text(face = "bold"),
        axis.ticks = element_blank(),
        axis.text.x.bottom = element_text(colour = "white"),
        axis.text.y.left = element_text(colour = "white"),
        panel.background = element_rect(fill = "black", colour = "white"),
        plot.background = element_rect(fill = "#15202b"),
        plot.margin = margin(1, 1, 1, 1, "cm"))
```

# Animated plot

```{r}
animated_plot <- p +
  transition_reveal(date) +
  shadow_trail()

options(gganimate.dev_args = list(height = 6, width = 10.6667, units = 'in', type = "cairo", res = 144))

animate(plot = animated_plot,
        fps = 10,
        duration = 12,
        renderer = gifski_renderer("animations/toronto_restaurant_shutdown.gif"))
```

